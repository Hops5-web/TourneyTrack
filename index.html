<!DOCTYPE html>
<html lang="ru" data-bs-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TourneyTrack ‚Äî –¢—É—Ä–Ω–∏—Ä–Ω–∞—è –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ */
    body {
      padding-top: 70px;
      overflow-x: hidden;
    }
    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 10px;
      object-fit: cover;
      border: 2px solid var(--bs-border-color);
    }
    .page-header {
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid var(--bs-border-color);
    }
    .section-title {
      font-weight: 600;
      color: var(--bs-heading-color, var(--bs-body-color));
      margin-bottom: 1.25rem;
      font-size: 1.5rem;
    }

    /* Leaderboard */
    .leaderboard-item {
      display: flex;
      align-items: center;
      padding: 1rem;
      margin-bottom: 0.75rem;
      background: var(--bs-card-bg);
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      border: 1px solid var(--bs-border-color);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .leaderboard-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }
    .place-badge {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 1rem;
      font-weight: bold;
      color: white;
      font-size: 1.1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .place-1 { background: #FFD700; color: #333; }
    .place-2 { background: #C0C0C0; }
    .place-3 { background: #CD7F32; }
    .place-other { background: var(--bs-secondary); }
    .points.positive {
      color: var(--bs-success);
      font-weight: 600;
      font-size: 1.1rem;
    }
    .points.negative {
      color: var(--bs-danger);
      font-weight: 600;
      font-size: 1.1rem;
    }

    /* –≠—Ç–∞–ø—ã */
    .stage-box {
      background: var(--bs-tertiary-bg);
      padding: 1.25rem;
      border-radius: 12px;
      margin-bottom: 1.5rem;
      border: 1px solid var(--bs-border-color);
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .stage-title {
      font-weight: 600;
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 0.75rem;
      font-size: 1.25rem;
    }
    .stage-meta {
      font-size: 0.95rem;
      color: var(--bs-secondary-color);
      background: rgba(0,0,0,0.05);
      padding: 0.25rem 0.5rem;
      border-radius: 6px;
    }
    [data-bs-theme="dark"] .stage-meta {
      background: rgba(255,255,255,0.05);
    }
    .stage-players {
      list-style: none;
      padding: 0;
    }
    .stage-player {
      display: flex;
      align-items: center;
      padding: 0.5rem 0;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .arrow-right {
      color: var(--bs-secondary-color);
      margin: 0 0.75rem;
      font-weight: bold;
      font-size: 1.1rem;
    }

    /* –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä */
    .constructor-section {
      background: var(--bs-secondary-bg);
      padding: 1.5rem;
      border-radius: 12px;
      margin-bottom: 1.5rem;
      border: 1px solid var(--bs-border-color);
    }
    .constructor-item {
      background: var(--bs-body-bg);
      padding: 1.25rem;
      border-radius: 12px;
      margin-bottom: 1.25rem;
      position: relative;
      border: 1px solid var(--bs-border-color);
    }
    .btn-remove {
      position: absolute;
      top: 12px;
      right: 12px;
    }
    .global-players-container {
      max-height: 320px;
      overflow-y: auto;
      padding: 1rem;
      background: var(--bs-tertiary-bg);
      border-radius: 12px;
      margin: 1rem 0;
      border: 1px solid var(--bs-border-color);
    }
    .global-player-item {
      display: flex;
      align-items: center;
      padding: 0.75rem;
      background: var(--bs-body-bg);
      border-radius: 8px;
      margin-bottom: 0.5rem;
      border: 1px solid var(--bs-border-color-translucent);
    }

    /* –û–ø–∏—Å–∞–Ω–∏–µ —Ç—É—Ä–Ω–∏—Ä–∞ */
    .tournament-description {
      background: var(--bs-tertiary-bg);
      padding: 1.25rem;
      border-radius: 12px;
      margin: 1.5rem 0;
      white-space: pre-line;
      border: 1px solid var(--bs-border-color);
      line-height: 1.6;
    }

    /* –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π */
    .responsible-badge {
      font-size: 0.95rem;
      background: var(--bs-primary);
      color: white;
      padding: 0.35rem 0.75rem;
      border-radius: 8px;
      display: inline-block;
      font-weight: 500;
    }

    /* Game badge */
    .game-badge {
      font-weight: 500;
      padding: 0.35rem 0.75rem;
      border-radius: 8px;
      background: var(--bs-success);
      color: white;
    }

    /* –°—Ç–∞—Ç—É—Å —ç—Ç–∞–ø–∞ */
    .stage-status-badge {
      padding: 0.35rem 0.75rem;
      border-radius: 8px;
      font-weight: 500;
      font-size: 0.9rem;
    }

    /* –ú–æ–±–∏–ª—å–Ω—ã–µ —Ñ–∏–∫—Å—ã */
    @media (max-width: 991.98px) {
      body {
        padding-top: 80px;
      }
      .navbar {
        padding-top: 0.5rem;
        padding-bottom: 0.5rem;
      }
      .theme-toggle-btn {
        margin-left: 0.5rem;
        height: 38px;
      }
    }
  </style>
</head>
<body>

  <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
  <nav class="navbar navbar-expand-lg bg-body-tertiary shadow-sm fixed-top">
    <div class="container">
      <a class="navbar-brand fw-bold" href="#/">TourneyTrack</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="#/rules">–ü—Ä–∞–≤–∏–ª–∞</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#/tournaments">–¢—É—Ä–Ω–∏—Ä—ã</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#/constructor">–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä</a>
          </li>
          <li class="nav-item">
            <button class="btn btn-outline-secondary theme-toggle-btn ms-2" onclick="toggleTheme()">üåô / ‚òÄÔ∏è</button>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container">
    <div id="app"></div>
  </div>

  <script>
    // === –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ===
    function toggleTheme() {
      const html = document.documentElement;
      const current = html.getAttribute('data-bs-theme');
      const newTheme = current === 'light' ? 'dark' : 'light';
      html.setAttribute('data-bs-theme', newTheme);
      localStorage.setItem('theme', newTheme);
    }

    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–º—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    function restoreTheme() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-bs-theme', savedTheme);
    }

    restoreTheme();

    async function fetchTournaments() {
      try {
        const response = await fetch('tournaments.json');
        const data = await response.json();
        return data.tournaments || [];
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—É—Ä–Ω–∏—Ä–æ–≤:", err);
        return [];
      }
    }

    // –†–æ—É—Ç–∏–Ω–≥
    function router() {
      const hash = window.location.hash || '#/';
      const app = document.getElementById('app');

      if (hash === '#/rules') {
        renderRules(app);
      } else if (hash === '#/constructor') {
        renderConstructor(app);
      } else if (hash.startsWith('#/tournament/')) {
        const id = hash.split('/').pop();
        renderTournament(app, id);
      } else {
        renderTournamentsList(app);
      }
    }

    // === –†–µ–Ω–¥–µ—Ä—ã ===

    function renderRules(container) {
      container.innerHTML = `
        <div class="page-header">
          <h1 class="section-title">üìú –ü—Ä–∞–≤–∏–ª–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —Ç—É—Ä–Ω–∏—Ä–æ–≤</h1>
        </div>

        <div class="card p-4">
          <h5>–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞:</h5>
          <ol>
            <li><strong>–ü–æ–¥—Å–∫–∞–∑–∫–∏ –∑–∞–ø—Ä–µ—â–µ–Ω—ã</strong> ‚Äî –∏–≥—Ä–æ–∫ –Ω–µ –¥–æ–ª–∂–µ–Ω –ø–æ–º–æ–≥–∞—Ç—å –¥—Ä—É–≥–∏–º, —à–µ–ø—Ç–∞—Ç—å, –∂–µ—Å—Ç–∏–∫—É–ª–∏—Ä–æ–≤–∞—Ç—å –∏–ª–∏ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ª—é–±—ã–º —Å–ø–æ—Å–æ–±–æ–º.<br>‚Üí <em>–í—ã–≥–æ–≤–æ—Ä + —Å–Ω—è—Ç–∏–µ –æ—á–∫–æ–≤ –∑–∞ –≤–æ–ø—Ä–æ—Å / —Ä–∞—É–Ω–¥.</em></li>
            <li><strong>–ú–µ—à–∞—Ç—å –¥—Ä—É–≥–∏–º ‚Äî –Ω–µ–ª—å–∑—è</strong> ‚Äî –≥—Ä–æ–º–∫–∏–µ –≤—ã–∫—Ä–∏–∫–∏, –ø–µ—Ä–µ–±–∏–≤–∞–Ω–∏—è, —Å–∞–±–æ—Ç–∞–∂ —Ö–æ–¥–∞ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞ –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã.<br>‚Üí <em>–í—ã–≥–æ–≤–æ—Ä + —Å–Ω—è—Ç–∏–µ –æ—á–∫–æ–≤ / —É–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –∏–≥—Ä—ã –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–µ.</em></li>
            <li><strong>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤–Ω–µ—à–Ω–∏—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤</strong> ‚Äî —Ç–µ–ª–µ—Ñ–æ–Ω—ã, –∑–∞–º–µ—Ç–∫–∏, –∏–Ω—Ç–µ—Ä–Ω–µ—Ç ‚Äî –∑–∞–ø—Ä–µ—â–µ–Ω—ã –≤–æ –≤—Ä–µ–º—è –∏–≥—Ä—ã.<br>‚Üí <em>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∞–Ω–Ω—É–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ö–æ–¥–∞ + —à—Ç—Ä–∞—Ñ–Ω—ã–µ –æ—á–∫–∏.</em></li>
            <li><strong>–ù–∞—Ä—É—à–µ–Ω–∏–µ –ø–æ—Ä—è–¥–∫–∞ —Ö–æ–¥–∞</strong> ‚Äî –æ—Ç–≤–µ—á–∞—Ç—å –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –≤–µ–¥—É—â–µ–≥–æ, –Ω–µ –ø–µ—Ä–µ–±–∏–≤–∞—è.<br>‚Üí <em>–û—Ç–≤–µ—Ç –Ω–µ –∑–∞—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è, —Ö–æ–¥ –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è —Å–æ–ø–µ—Ä–Ω–∏–∫—É.</em></li>
            <li><strong>–û—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è –∏ –Ω–µ—É–≤–∞–∂–µ–Ω–∏–µ</strong> ‚Äî –∫ –∏–≥—Ä–æ–∫–∞–º, –≤–µ–¥—É—â–µ–º—É, –∑—Ä–∏—Ç–µ–ª—è–º ‚Äî –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã.<br>‚Üí <em>–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ ‚Üí –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–µ ‚Äî —É–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –∏–≥—Ä—ã.</em></li>
          </ol>

          <h5 class="mt-4">–ü–æ–ª–Ω–æ–º–æ—á–∏—è –≤–µ–¥—É—â–µ–≥–æ:</h5>
          <ul>
            <li>–í–µ–¥—É—â–∏–π ‚Äî –≥–ª–∞–≤–Ω—ã–π –∞—Ä–±–∏—Ç—Ä. –ò–º–µ–µ—Ç –ø—Ä–∞–≤–æ:
              <ul>
                <li>–ê–Ω—É–ª–∏—Ä–æ–≤–∞—Ç—å / –¥–æ–Ω–∞—á–∏—Å–ª–∏—Ç—å / —Å–Ω—è—Ç—å –æ—á–∫–∏.</li>
                <li>–ò–∑–º–µ–Ω–∏—Ç—å –∏–ª–∏ –æ—Ç–º–µ–Ω–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ –Ω–∞ –º–µ—Å—Ç–µ.</li>
                <li>–£–¥–∞–ª–∏—Ç—å –∏–≥—Ä–æ–∫–∞ –∑–∞ –≥—Ä—É–±–æ–µ –Ω–∞—Ä—É—à–µ–Ω–∏–µ.</li>
              </ul>
            </li>
            <li>–†–µ—à–µ–Ω–∏–µ –≤–µ–¥—É—â–µ–≥–æ –≤ —Ä–∞–º–∫–∞—Ö –∏–≥—Ä—ã ‚Äî –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ.</li>
          </ul>

          <h5 class="mt-4">–û–±–∂–∞–ª–æ–≤–∞–Ω–∏–µ:</h5>
          <p>–ò–≥—Ä–æ–∫–∏ –º–æ–≥—É—Ç –æ–±–∂–∞–ª–æ–≤–∞—Ç—å —Ä–µ—à–µ–Ω–∏–µ <strong>—Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∏–≥—Ä—ã</strong>, –ø—Ä–∏–ª–æ–∂–∏–≤ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ (–≤–∏–¥–µ–æ, —Å–∫—Ä–∏–Ω—à–æ—Ç—ã, —Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–∞).<br>
          –†–µ—à–µ–Ω–∏—è —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞—é—Ç—Å—è –≤ <strong>–¥–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω–µ–º –ø–æ—Ä—è–¥–∫–µ</strong> –º–µ–∂–¥—É –∏–≥—Ä–æ–∫–æ–º –∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–∞–º–∏.</p>

          <p class="text-muted mt-3"><em>–ü—Ä–∞–≤–∏–ª–∞ –º–æ–≥—É—Ç –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤–µ–¥—É—â–∏–º –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –∏–≥—Ä—ã ‚Äî –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω—ã–µ —Å–∏—Ç—É–∞—Ü–∏–∏ —Ç—Ä–µ–±—É—é—Ç –≥–∏–±–∫–æ—Å—Ç–∏. –¶–µ–ª—å ‚Äî —á–µ—Å—Ç–Ω–∞—è –∏ –≤–µ—Å—ë–ª–∞—è –∏–≥—Ä–∞ –¥–ª—è –≤—Å–µ—Ö.</em></p>
        </div>
      `;
    }

    async function renderTournamentsList(container) {
      const tournaments = await fetchTournaments();
      container.innerHTML = `
        <div class="page-header">
          <h1 class="section-title">üèÜ –¢—É—Ä–Ω–∏—Ä—ã</h1>
        </div>
      `;

      if (tournaments.length === 0) {
        container.innerHTML += `<div class="alert alert-info">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç—É—Ä–Ω–∏—Ä–æ–≤.</div>`;
        return;
      }

      let html = `<div class="row g-3">`;
      tournaments.forEach(t => {
        const statusClass = getStatusBadgeClass(t.status);
        const gameBadge = t.game ? `<span class="game-badge">${t.game}</span>` : '';
        const responsible = t.responsible ? `<div class="mt-2 mb-3"><span class="responsible-badge">üë§ ${t.responsible}</span></div>` : '';

        html += `
          <div class="col-md-6 col-lg-4">
            <div class="card h-100 shadow-sm">
              <div class="card-body d-flex flex-column">
                <h5 class="card-title">${t.title}</h5>
                ${gameBadge ? `<div class="mb-2">${gameBadge}</div>` : ''}
                <div class="text-muted small mb-2">üìÖ ${t.date}</div>
                <span class="badge bg-${statusClass} mb-2 align-self-start">${t.status || '‚Äî'}</span>
                ${responsible}
                <a href="#/tournament/${t.id}" class="btn btn-primary mt-auto">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a>
              </div>
            </div>
          </div>
        `;
      });
      html += `</div>`;
      container.innerHTML += html;
    }

    function getStatusBadgeClass(status) {
      if (!status) return "secondary";
      if (status.includes("–ó–∞–≤–µ—Ä—à—ë–Ω")) return "success";
      if (status.includes("–ò–¥—ë—Ç")) return "warning";
      if (status.includes("–ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è")) return "info";
      return "secondary";
    }

    async function renderTournament(container, id) {
      const tournaments = await fetchTournaments();
      const tournament = tournaments.find(t => t.id === id);

      if (!tournament) {
        container.innerHTML = `<div class="alert alert-danger">–¢—É—Ä–Ω–∏—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω.</div>`;
        return;
      }

      let html = `
        <div class="page-header">
          <h1 class="section-title">${tournament.title}</h1>
          <div class="d-flex flex-wrap align-items-center gap-3 text-muted mt-2">
            <span>üìÖ ${tournament.date}</span>
            <span class="badge bg-${getStatusBadgeClass(tournament.status)}">${tournament.status || '‚Äî'}</span>
            ${tournament.game ? `<span class="game-badge">${tournament.game}</span>` : ''}
            ${tournament.responsible ? `<span class="responsible-badge">üë§ ${tournament.responsible}</span>` : ''}
          </div>
        </div>
      `;

      // –û–ø–∏—Å–∞–Ω–∏–µ
      if (tournament.description) {
        html += `
          <div class="tournament-description">
            <h5>üìã –û–ø–∏—Å–∞–Ω–∏–µ —Ç—É—Ä–Ω–∏—Ä–∞</h5>
            <div>${tournament.description}</div>
          </div>
        `;
      }

      // –≠—Ç–∞–ø—ã
      if (tournament.stages && tournament.stages.length > 0) {
        html += `<h3 class="mt-4 mb-3">üîÑ –≠—Ç–∞–ø—ã —Ç—É—Ä–Ω–∏—Ä–∞</h3>`;
        tournament.stages.forEach((stage, idx) => {
          const nextStage = tournament.stages[idx + 1];
          const isFinal = !nextStage;

          html += `
            <div class="stage-box">
              <div class="stage-title">
                –≠—Ç–∞–ø ${idx + 1}: ${stage.name || `–†–∞—É–Ω–¥ ${idx + 1}`}
                <span class="stage-status-badge bg-${getStageStatusClass(stage.status)}">${stage.status || '‚Äî'}</span>
                ${stage.datetime ? `<span class="stage-meta">üïó ${stage.datetime}</span>` : ''}
              </div>
              <ul class="stage-players">
          `;

          stage.players.forEach(player => {
            const passed = nextStage && nextStage.players.some(p => p.nickname === player.nickname);
            let pointsHtml = '';
            if (player.points !== undefined && player.points !== null) {
              const pointsClass = player.points > 0 ? 'positive' : player.points < 0 ? 'negative' : '';
              const displayPoints = player.points >= 0 ? `+${player.points}` : player.points;
              pointsHtml = `<span class="points ${pointsClass}">${displayPoints}</span>`;
            }

            html += `
              <li class="stage-player">
                <img src="${player.discordAvatar || 'https://via.placeholder.com/40'}" class="avatar" onerror="this.src='https://via.placeholder.com/40'">
                <strong>${player.nickname}</strong>
                ${player.status ? `<span class="ms-2 badge bg-secondary">${player.status}</span>` : ''}
                ${pointsHtml}
                ${passed ? '<span class="arrow-right">‚Üí –ü—Ä–æ—à—ë–ª</span>' : ''}
              </li>
            `;
          });

          html += `</ul></div>`;
        });
      }

      // –ò—Ç–æ–≥–æ–≤—ã–π —Ä–µ–π—Ç–∏–Ω–≥ ‚Äî —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ
      if (tournament.showFinalRanking !== false && tournament.stages?.length > 0) {
        const finalStage = tournament.stages[tournament.stages.length - 1];
        if (finalStage.players.some(p => p.points !== undefined && p.points !== null)) {
          const sorted = [...finalStage.players]
            .filter(p => p.points !== undefined && p.points !== null)
            .sort((a, b) => b.points - a.points);

          if (sorted.length > 0) {
            html += `<h3 class="mt-5 mb-3">üèÖ –ò—Ç–æ–≥–æ–≤—ã–π —Ä–µ–π—Ç–∏–Ω–≥</h3>`;
            sorted.forEach((p, i) => {
              const place = i + 1;
              let placeClass = "place-other";
              if (place === 1) placeClass = "place-1";
              else if (place === 2) placeClass = "place-2";
              else if (place === 3) placeClass = "place-3";

              let pointsHtml = '';
              if (p.points !== undefined && p.points !== null) {
                const pointsClass = p.points > 0 ? 'positive' : p.points < 0 ? 'negative' : '';
                const displayPoints = p.points >= 0 ? `+${p.points}` : p.points;
                pointsHtml = `<div class="points ${pointsClass} fs-5">${displayPoints}</div>`;
              }

              html += `
                <div class="leaderboard-item">
                  <div class="place-badge ${placeClass}">${place}</div>
                  <img src="${p.discordAvatar || 'https://via.placeholder.com/40'}" class="avatar" onerror="this.src='https://via.placeholder.com/40'">
                  <div class="flex-grow-1">
                    <strong>${p.nickname}</strong>
                    ${p.status ? `<div><span class="badge bg-secondary">${p.status}</span></div>` : ''}
                  </div>
                  ${pointsHtml}
                </div>
              `;
            });
          }
        }
      }

      container.innerHTML = html;
    }

    async function renderConstructor(container) {
      const tournaments = await fetchTournaments();
      container.innerHTML = `
        <div class="page-header">
          <h1 class="section-title">üõ†Ô∏è –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Ç—É—Ä–Ω–∏—Ä–∞</h1>
        </div>

        <div class="mb-4">
          <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ —Ç—É—Ä–Ω–∏—Ä –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
          <select id="editSelect" class="form-select">
            <option value="">‚Äî –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π ‚Äî</option>
          </select>
        </div>

        <div class="constructor-section">
          <h4>–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>
          <div class="mb-3">
            <label class="form-label">ID —Ç—É—Ä–Ω–∏—Ä–∞ (–ª–∞—Ç–∏–Ω–∏—Ü–∞, –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤)</label>
            <input type="text" id="tournamentId" class="form-control" placeholder="tournament_spring_2025">
          </div>
          <div class="mb-3">
            <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—É—Ä–Ω–∏—Ä–∞</label>
            <input type="text" id="tournamentTitle" class="form-control" placeholder="–í–µ—Å–µ–Ω–Ω–∏–π –¢—É—Ä–Ω–∏—Ä 2025">
          </div>
          <div class="mb-3">
            <label class="form-label">–ò–≥—Ä–∞</label>
            <input type="text" id="tournamentGame" class="form-control" placeholder="SIGAME / Codenames / –ö–≤–∏–∑ –∏ —Ç.–¥.">
          </div>
          <div class="mb-3">
            <label class="form-label">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –∑–∞ —Ç—É—Ä–Ω–∏—Ä</label>
            <input type="text" id="tournamentResponsible" class="form-control" placeholder="–ò–º—è, –Ω–∏–∫, —Ä–æ–ª—å (–Ω–∞–ø—Ä–∏–º–µ—Ä: @Host, –û—Ä–≥–∫–æ–º–∏—Ç–µ—Ç)">
          </div>
          <div class="mb-3">
            <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ —Ç—É—Ä–Ω–∏—Ä–∞</label>
            <textarea id="tournamentDescription" class="form-control" rows="3" placeholder="–§–æ—Ä–º–∞—Ç, –æ—Å–æ–±—ã–µ –ø—Ä–∞–≤–∏–ª–∞, –ø—Ä–∏–∑—ã, –∫–æ–Ω—Ç–∞–∫—Ç—ã –∏ —Ç.–¥."></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">–î–∞—Ç–∞ —Ç—É—Ä–Ω–∏—Ä–∞ (–æ–±—â–∞—è)</label>
            <input type="text" id="tournamentDate" class="form-control" placeholder="15 –º–∞—Ä—Ç–∞ 2025">
          </div>
          <div class="mb-3">
            <label class="form-label">–°—Ç–∞—Ç—É—Å —Ç—É—Ä–Ω–∏—Ä–∞</label>
            <select id="tournamentStatus" class="form-select">
              <option value="–ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è">–ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è</option>
              <option value="–ò–¥—ë—Ç">–ò–¥—ë—Ç</option>
              <option value="–ó–∞–≤–µ—Ä—à—ë–Ω">–ó–∞–≤–µ—Ä—à—ë–Ω</option>
            </select>
          </div>
          <div class="mb-3 form-check">
            <input type="checkbox" class="form-check-input" id="showFinalRanking" checked>
            <label class="form-check-label" for="showFinalRanking">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∏—Ç–æ–≥–æ–≤—ã–π —Ä–µ–π—Ç–∏–Ω–≥</label>
          </div>
        </div>

        <div class="constructor-section">
          <h4>üë• –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</h4>
          <p>–î–æ–±–∞–≤—å—Ç–µ –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤ –∑–¥–µ—Å—å ‚Äî –ø–æ—Ç–æ–º –≤—ã–±–∏—Ä–∞–π—Ç–µ –∏—Ö –≤ —ç—Ç–∞–ø–∞—Ö —á–µ—Ä–µ–∑ –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫.</p>
          <div id="globalPlayersContainer" class="global-players-container"></div>
          <button class="btn btn-outline-primary mt-2" onclick="addGlobalPlayer()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∏–≥—Ä–æ–∫–∞</button>
        </div>

        <div class="constructor-section">
          <h4>–≠—Ç–∞–ø—ã —Ç—É—Ä–Ω–∏—Ä–∞</h4>
          <div id="stagesContainer"></div>
          <button class="btn btn-success mt-2" onclick="addStage()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —ç—Ç–∞–ø</button>
        </div>

        <button class="btn btn-primary mt-3" onclick="generateJSON()">üì• –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å JSON</button>

        <div class="mt-4">
          <h5>–†–µ–∑—É–ª—å—Ç–∞—Ç:</h5>
          <textarea id="resultJSON" class="form-control" rows="10" readonly></textarea>
          <button class="btn btn-outline-secondary mt-2" onclick="copyJSON()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
          <div class="alert alert-warning mt-2">
            <strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</strong> –°–∫–æ–ø–∏—Ä—É–π—Ç–µ JSON –∏ –≤—Ä—É—á–Ω—É—é –∑–∞–º–µ–Ω–∏—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ tournaments.json
          </div>
        </div>
      `;

      // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
      const editSelect = document.getElementById('editSelect');
      tournaments.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t.id;
        opt.textContent = `${t.title} (${t.id})`;
        editSelect.appendChild(opt);
      });

      editSelect.addEventListener('change', (e) => {
        if (e.target.value) {
          const tour = tournaments.find(t => t.id === e.target.value);
          if (tour) loadTournamentToForm(tour);
        } else {
          clearForm();
        }
      });

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
      window.globalPlayerIndex = 0;
      window.stageIndex = 0;
      addGlobalPlayer();
      addStage();
    }

    function clearForm() {
      document.getElementById('tournamentId').value = '';
      document.getElementById('tournamentTitle').value = '';
      document.getElementById('tournamentGame').value = '';
      document.getElementById('tournamentResponsible').value = '';
      document.getElementById('tournamentDescription').value = '';
      document.getElementById('tournamentDate').value = '';
      document.getElementById('tournamentStatus').value = '–ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è';
      document.getElementById('showFinalRanking').checked = true;
      document.getElementById('globalPlayersContainer').innerHTML = '';
      document.getElementById('stagesContainer').innerHTML = '';
      window.globalPlayerIndex = 0;
      window.stageIndex = 0;
      addGlobalPlayer();
      addStage();
    }

    function loadTournamentToForm(t) {
      document.getElementById('tournamentId').value = t.id || '';
      document.getElementById('tournamentTitle').value = t.title || '';
      document.getElementById('tournamentGame').value = t.game || '';
      document.getElementById('tournamentResponsible').value = t.responsible || '';
      document.getElementById('tournamentDescription').value = t.description || '';
      document.getElementById('tournamentDate').value = t.date || '';
      document.getElementById('tournamentStatus').value = t.status || '–ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è';
      document.getElementById('showFinalRanking').checked = t.showFinalRanking !== false;

      const globalContainer = document.getElementById('globalPlayersContainer');
      globalContainer.innerHTML = '';
      window.globalPlayerIndex = 0;

      // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ—Ö —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤
      const allPlayers = new Map();
      if (t.stages) {
        t.stages.forEach(stage => {
          stage.players.forEach(p => {
            if (!allPlayers.has(p.nickname)) {
              allPlayers.set(p.nickname, p);
            }
          });
        });
      }

      allPlayers.forEach(player => {
        addGlobalPlayer(player);
      });

      const stagesContainer = document.getElementById('stagesContainer');
      stagesContainer.innerHTML = '';
      window.stageIndex = 0;

      if (t.stages && t.stages.length > 0) {
        t.stages.forEach(stage => {
          addStage(stage);
        });
      } else {
        addStage();
      }
    }

    function addGlobalPlayer(playerData = null) {
      const container = document.getElementById('globalPlayersContainer');
      const idx = ++window.globalPlayerIndex;
      const div = document.createElement('div');
      div.className = 'global-player-item';
      div.innerHTML = `
        <strong>–ò–≥—Ä–æ–∫ #${idx}</strong>
        <button type="button" class="btn btn-sm btn-outline-danger ms-auto" onclick="this.closest('.global-player-item').remove()">üóëÔ∏è</button>
        <div class="w-100 mt-2">
          <input type="text" class="form-control player-nickname" placeholder="–ù–∏–∫–Ω–µ–π–º" value="${playerData?.nickname || ''}">
        </div>
        <div class="mt-1">
          <input type="text" class="form-control player-avatar" placeholder="URL –∞–≤–∞—Ç–∞—Ä–∞ Discord" value="${playerData?.discordAvatar || ''}">
        </div>
      `;
      container.appendChild(div);
    }

    function getGlobalPlayers() {
      const players = [];
      document.querySelectorAll('#globalPlayersContainer .global-player-item').forEach(item => {
        const nickname = item.querySelector('.player-nickname').value.trim();
        if (!nickname) return;
        const avatar = item.querySelector('.player-avatar').value.trim() || null;
        players.push({ nickname, discordAvatar: avatar });
      });
      return players;
    }

    function addStage(stageData = null) {
      const container = document.getElementById('stagesContainer');
      const idx = ++window.stageIndex;
      const div = document.createElement('div');
      div.className = 'constructor-item';
      div.innerHTML = `
        <button type="button" class="btn btn-sm btn-danger btn-remove" onclick="this.closest('.constructor-item').remove()">üóëÔ∏è</button>
        <h5>–≠—Ç–∞–ø ${idx}</h5>
        <div class="mb-2">
          <label>–ù–∞–∑–≤–∞–Ω–∏–µ —ç—Ç–∞–ø–∞</label>
          <input type="text" class="form-control stage-name" placeholder="–†–∞—É–Ω–¥ 1" value="${stageData?.name || ''}">
        </div>
        <div class="mb-2">
          <label>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è —ç—Ç–∞–ø–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
          <input type="text" class="form-control stage-datetime" placeholder="15 –º–∞—Ä—Ç–∞, 19:00" value="${stageData?.datetime || ''}">
        </div>
        <div class="mb-2">
          <label>–°—Ç–∞—Ç—É—Å —ç—Ç–∞–ø–∞</label>
          <select class="form-select stage-status">
            <option value="–ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è" ${stageData?.status === '–ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è' ? 'selected' : ''}>–ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è</option>
            <option value="–ò–¥—ë—Ç" ${stageData?.status === '–ò–¥—ë—Ç' ? 'selected' : ''}>–ò–¥—ë—Ç</option>
            <option value="–ó–∞–≤–µ—Ä—à—ë–Ω" ${stageData?.status === '–ó–∞–≤–µ—Ä—à—ë–Ω' ? 'selected' : ''}>–ó–∞–≤–µ—Ä—à—ë–Ω</option>
          </select>
        </div>
        <h6>–ò–≥—Ä–æ–∫–∏ —ç—Ç–∞–ø–∞</h6>
        <div class="players-container"></div>
        <button class="btn btn-outline-success btn-sm mt-2" onclick="addPlayerToStage(this)">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∏–≥—Ä–æ–∫–∞ –∏–∑ —Å–ø–∏—Å–∫–∞</button>
      `;

      const playersContainer = div.querySelector('.players-container');
      if (stageData && stageData.players) {
        stageData.players.forEach(player => {
          addPlayerToStage(null, playersContainer, player);
        });
      }

      container.appendChild(div);
    }

    function addPlayerToStage(button, container = null, playerData = null) {
      if (!container && button) {
        container = button.closest('.constructor-item').querySelector('.players-container');
      }

      const globalPlayers = getGlobalPlayers();
      if (globalPlayers.length === 0) {
        alert("–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ –∏–≥—Ä–æ–∫–æ–≤ –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫!");
        return;
      }

      const div = document.createElement('div');
      div.className = 'card mb-2 p-2';
      let options = '';
      globalPlayers.forEach(p => {
        const selected = playerData && playerData.nickname === p.nickname ? 'selected' : '';
        options += `<option value="${p.nickname}" ${selected}>${p.nickname}</option>`;
      });

      div.innerHTML = `
        <div class="mb-1">
          <label>–ò–≥—Ä–æ–∫</label>
          <select class="form-select player-select">
            <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä–æ–∫–∞ ‚Äî</option>
            ${options}
          </select>
        </div>
        <div class="mb-1">
          <label>–°—Ç–∞—Ç—É—Å</label>
          <select class="form-select player-status">
            <option value="">‚Äî –ë–µ–∑ —Å—Ç–∞—Ç—É—Å–∞ ‚Äî</option>
            <option value="–ü–æ–±–µ–¥–∏—Ç–µ–ª—å" ${playerData?.status === '–ü–æ–±–µ–¥–∏—Ç–µ–ª—å' ? 'selected' : ''}>–ü–æ–±–µ–¥–∏—Ç–µ–ª—å</option>
            <option value="–§–∏–Ω–∞–ª–∏—Å—Ç" ${playerData?.status === '–§–∏–Ω–∞–ª–∏—Å—Ç' ? 'selected' : ''}>–§–∏–Ω–∞–ª–∏—Å—Ç</option>
            <option value="–ü–æ–ª—É—Ñ–∏–Ω–∞–ª–∏—Å—Ç" ${playerData?.status === '–ü–æ–ª—É—Ñ–∏–Ω–∞–ª–∏—Å—Ç' ? 'selected' : ''}>–ü–æ–ª—É—Ñ–∏–Ω–∞–ª–∏—Å—Ç</option>
            <option value="–ü—Ä–æ—à—ë–ª" ${playerData?.status === '–ü—Ä–æ—à—ë–ª' ? 'selected' : ''}>–ü—Ä–æ—à—ë–ª</option>
            <option value="–í—ã–±—ã–ª" ${playerData?.status === '–í—ã–±—ã–ª' ? 'selected' : ''}>–í—ã–±—ã–ª</option>
            <option value="–î–∏—Å–∫–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω" ${playerData?.status === '–î–∏—Å–∫–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω' ? 'selected' : ''}>–î–∏—Å–∫–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω</option>
          </select>
        </div>
        <div class="mb-1">
          <label>–û—á–∫–∏</label>
          <input type="number" class="form-control player-points" placeholder="–û—á–∫–∏" value="${playerData?.points !== undefined ? playerData.points : ''}">
        </div>
        <button class="btn btn-sm btn-outline-danger" type="button" onclick="this.closest('div.card').remove()">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
      `;
      container.appendChild(div);
    }

    function generateJSON() {
      const id = document.getElementById('tournamentId').value.trim();
      const title = document.getElementById('tournamentTitle').value.trim();
      const game = document.getElementById('tournamentGame').value.trim() || null;
      const responsible = document.getElementById('tournamentResponsible').value.trim() || null;
      const description = document.getElementById('tournamentDescription').value.trim() || null;
      const date = document.getElementById('tournamentDate').value.trim();
      const status = document.getElementById('tournamentStatus').value;
      const showFinalRanking = document.getElementById('showFinalRanking').checked;

      if (!id || !title) {
        alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ ID –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç—É—Ä–Ω–∏—Ä–∞!');
        return;
      }

      const globalPlayers = getGlobalPlayers();
      if (globalPlayers.length === 0) {
        alert('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞!');
        return;
      }

      const stages = [];
      document.querySelectorAll('#stagesContainer > .constructor-item').forEach(stageDiv => {
        const name = stageDiv.querySelector('.stage-name').value.trim() || null;
        const datetime = stageDiv.querySelector('.stage-datetime').value.trim() || null;
        const stageStatus = stageDiv.querySelector('.stage-status').value || '–ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è';

        const players = [];
        stageDiv.querySelectorAll('.players-container > .card').forEach(playerDiv => {
          const nickname = playerDiv.querySelector('.player-select').value.trim();
          if (!nickname) return;

          const globalPlayer = globalPlayers.find(p => p.nickname === nickname);
          const status = playerDiv.querySelector('.player-status').value || null;
          const pointsStr = playerDiv.querySelector('.player-points').value.trim();
          const points = pointsStr === '' ? null : parseInt(pointsStr);

          players.push({
            nickname,
            discordAvatar: globalPlayer?.discordAvatar || null,
            status,
            points
          });
        });

        if (players.length > 0) {
          stages.push({ name, datetime, status: stageStatus, players });
        }
      });

      if (stages.length === 0) {
        alert('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —ç—Ç–∞–ø —Å –∏–≥—Ä–æ–∫–∞–º–∏!');
        return;
      }

      const tournamentObject = {
        id, title, game, responsible, description, date, status, showFinalRanking, stages
      };

      const jsonString = JSON.stringify(tournamentObject, null, 2);
      document.getElementById('resultJSON').value = jsonString;
    }

    function copyJSON() {
      const textarea = document.getElementById('resultJSON');
      textarea.select();
      document.execCommand('copy');
      alert('JSON —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
    }

    function getStageStatusClass(status) {
      if (!status) return "secondary";
      if (status === "–ó–∞–≤–µ—Ä—à—ë–Ω") return "success";
      if (status === "–ò–¥—ë—Ç") return "warning";
      if (status === "–ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è") return "info";
      return "secondary";
    }

    // –ó–∞–ø—É—Å–∫
    window.addEventListener('hashchange', router);
    window.addEventListener('load', router);
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
